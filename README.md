# Run:ai cluster migration script

The script helps automate the task of moving the following objects from one cluster to another:
- Projects
- Departments
- Node Pools
- Access Rules
- Compute Assets
- Environment Assets
- Credentials
- Workload Templates
- Datasources
- Policies
- Interactive Workloads
- Training Workloads (not yet implemented)

> [!NOTE]  
Important notes: <br />
This script does not apply migration to the default node pool and the default department at the moment.
Please change them manually, before running the script. This includes changing references to their ids in any resources that might reference them that are not created by the script (such as PVCs or Secrets that reference the department ID in a label, relevant if you are migrating PVCs or Credentials). <br />
> <br />
> Make sure you also have an application API token for system administrator on tenant scope in each cluster <br />
> <br />
>If you are moving any Credentials resources and/or plan to copy PVCs from the old cluster to the new cluster, you will need to move those resources yourself, the script will not do that for you. Do not change the name of the resource when copying it from the old cluster to the new cluster, simply copy as is and the script will take care of updating the corresponding Datasource or Credential to reference it.<br /> Note that while moving PVCs is only required if you want to retain the data in the PVCs (and must be flagged with the ```--convert-new-pvc-datasources-to-existing``` flag), the Secrets for Credentials resources (whether the Credential was created from an existing Secret or the Credential was created from scratch in the UI) MUST be moved, as you cannot retrieve all the details of a given Credential from the API, it is only stored encrypted in the Postgres DB and in the cluster itself as a Secret. <br />
<br />
Whether you are moving PVCs, Secrets, or both, any resource that was originally generated by Runai will have the label ```run.ai/asset: <resource type>``` - you **must** remove this label - in the case of Secrets, you should replace it with the label ```run.ai/resource: <resource type>```. This is in addition to fixing any ```run.ai/department``` labels that reference old department ids.<br />

How to use:
1. clone the repository
2. Install the libraries ```pip install requests dataclasses```
3. First, use the ```retrieve_json.py``` script to get the JSON of the resources from the old cluster. You will have to set the ```--base_url```, ```--client_id```, ```--client_secret```, and ```--cluster_id``` arguments when you call the script.
4. Next, use the ```restore_json_REST.py``` script to use those JSON files to apply to the new cluster. You will have to set the ```--base_url```, ```--client_id```, ```--client_secret```, and ```--cluster_id``` arguments when you call the script. If you are migrating all of the PVCs created by Runai from the old cluster to the new cluster, you can also set  ```--convert_new_pvc_datasources_to_existing```, which will convert any PVC datasources that created a new PVC into datasources that expect an existing PVC with the generated name.
